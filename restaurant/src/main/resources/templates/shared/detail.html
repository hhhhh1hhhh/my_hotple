<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title th:text="${myplace.placeName}"></title>
  <script type="text/javascript" th:src="@{/js/comment.js}"></script>
  <div th:replace="fragments.html :: main-head"></div>
</head>
<body>
<nav th:replace="fragments.html :: main-nav"></nav>
<div class="card mb-3" bis_skin_checked="1" style="width: 60%; margin: 50px auto;">
  <h3 class="card-header" th:text="${myplace.placeName}"></h3>
  <div class="card-body" bis_skin_checked="1">
    <h5 class="card-title" th:text="${myplace.address}"></h5>
    <h6 class="card-subtitle text-muted" style="text-align: right"
        th:utext="' 글쓴이: ' + ${myplace.userNickname + '<br> 조회수: ' + myplace.views}"></h6>
  </div>
  <svg th:if="${myplace.fileAttached == 1}"
       xmlns="http://www.w3.org/2000/svg" class="d-block user-select-none" width="100%" height="0" aria-label="Placeholder: Image cap" focusable="false" role="img" preserveAspectRatio="xMidYMid slice" viewBox="0 0 318 180" style="font-size:1.125rem;text-anchor:middle">
    <text th:each="fileName: ${myplace.storedFileName}">
      <img th:src="@{|/upload/${fileName}|}" alt="">
    </text>
  </svg>
  <div class="card-body" bis_skin_checked="1">
    <p class="card-text" th:text="${myplace.category}"></p>
  </div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item" th:text="${myplace.contents}"></li>
  </ul>
  <div class="card-body" bis_skin_checked="1">
    <a href="#" class="card-link">좋아요 누르기</a>
    <div style="text-align: right">
      <a th:href="@{/shared/list(page=${page})}" class="card-link">목록</a>
    </div>
  </div>
  <div class="card-footer text-muted" bis_skin_checked="1"
       th:text="*{#temporals.format(myplace.createdTime, 'yyyy-MM-dd HH:mm:ss')}">
  </div>
</div>

<div class="card" bis_skin_checked="1"  style="width: 60%; margin: 50px auto;">
  <div class="card-body" bis_skin_checked="1">
    <h6 class="card-subtitle mb-2 text-muted" id="commentWriter" th:text="${nickname}"></h6>
    <div bis_skin_checked="1">
                <textarea type="text" class="form-control" placeholder="내용" id="commentContent"
                          style="margin-top: 10px; margin-bottom: 10px;" rows="3"></textarea>
    </div>
    <button type="button" class="btn btn-success" style="float: right;" onclick="commentWrite()">댓글작성</button>
  </div>
</div>

<div id="comment-list">
  <div class="card" bis_skin_checked="1"  style="width: 60%; margin: 50px auto;">
    <div class="card-body" bis_skin_checked="1" th:each="comment: ${commentList}">
      <h6 class="card-subtitle mb-2 text-muted" th:text="${comment.commentWriter}"></h6>
      <p class="card-text" th:text="${comment.commentContents}"></p>
      <div style="text-align: right">
        <p th:text="*{#temporals.format(comment.commentCreatedTime, 'yyyy-MM-dd HH:mm:ss')}"></p>
        <a href="#" class="card-link">수정</a>
        <a href="#" class="card-link">삭제</a>
      </div>
    </div>
  </div>
</div>


</body>
<script th:inline="javascript">
  const commentWrite = () => {

    const writer = [[${nickname}]];
    const contents = document.getElementById("commentContent").value;
    const id = [[${myplace.id}]]; // 게시글 번호

    console.log("작성자: ", writer);
    console.log("내용: ", contents);
    console.log("게시글 번호: ", id);

    $.ajax({
      // 요청 방식: post, 요청 주소: /comment/save, 요청 데이터: 작성자, 작성내용, 게시글 번호
      type: "post",
      url: "/comment/save",
      headers: {
        "X-CSRF-TOKEN": $('[name="_csrf"]').val()
      },
      data: {
        "commentWriter": writer,
        "commentContents": contents,
        "myplaceId": id
      },
      success: function (res) {
        console.log("요청성공", res);
        let output = "";

        for (let i in res) {
          output += '<div class="card mb-3" style="width: 60%; margin: 10px auto;">';
          output += '<div class="card-body">';
          output += '<h6 class="card-subtitle mb-2 text-muted">' + res[i].commentWriter + '</h6>';
          output += '<p class="card-text">' + res[i].commentContents + '</p>';
          output += '<div style="text-align: right">';
          output += '<p>' + res[i].commentCreatedTime + '</p>';
          output += '<a href="#" class="card-link">수정</a>';
          output += '<a href="#" class="card-link">삭제</a>';
          output += '</div></div></div>';
        }

        document.getElementById('comment-list').innerHTML = output;
        document.getElementById('commentContent').value = ''; // 내용 입력란 초기화
      },
      error: function(err) {
        console.log("요청 실패", err)
      }
    })
  }
</script>
</html>