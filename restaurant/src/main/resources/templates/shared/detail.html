<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title th:text="${myplace.placeName}"></title>
  <script type="text/javascript" th:src="@{/js/comment.js}"></script>
  <div th:replace="fragments.html :: main-head"></div>
</head>
<body>
<nav th:replace="fragments.html :: main-nav"></nav>
<div class="card mb-3" bis_skin_checked="1" style="width: 60%; margin: 50px auto;">
  <h3 class="card-header" th:text="${myplace.placeName}"></h3>
  <div class="card-body" bis_skin_checked="1">
    <h5 class="card-title" th:text="${myplace.address}"></h5>
    <h6 class="card-subtitle text-muted" style="text-align: right"
        th:utext="' 글쓴이: ' + ${myplace.userNickname + '<br> 조회수: ' + myplace.views}"></h6>
  </div>
  <svg th:if="${myplace.fileAttached == 1}"
       xmlns="http://www.w3.org/2000/svg" class="d-block user-select-none" width="100%" height="0" aria-label="Placeholder: Image cap" focusable="false" role="img" preserveAspectRatio="xMidYMid slice" viewBox="0 0 318 180" style="font-size:1.125rem;text-anchor:middle">
    <text th:each="fileName: ${myplace.storedFileName}">
      <img th:src="@{|/upload/${fileName}|}" alt="">
    </text>
  </svg>
  <div class="card-body" bis_skin_checked="1">
    <p class="card-text" th:text="${myplace.category}"></p>
  </div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item" th:text="${myplace.contents}"></li>
  </ul>
  <div class="card-body" bis_skin_checked="1">
    <a href="#" class="card-link">좋아요 누르기</a>
    <div style="text-align: right">
      <a th:href="@{/shared/list(page=${page})}" class="card-link">목록</a>
      <a th:if="${myplace.user.username == #authentication.name}" th:href="@{|/myplace/edit/${myplace.id}|}" class="card-link">수정</a>
      <a th:if="${myplace.user.username == #authentication.name}" th:href="@{|/myplace/delete/${myplace.id}|}" class="card-link" onclick="confirmDelete()">삭제</a>
    </div>
  </div>
  <div class="card-footer text-muted" bis_skin_checked="1"
       th:text="*{#temporals.format(myplace.createdTime, 'yyyy-MM-dd HH:mm:ss')}">
  </div>
</div>

<div class="card" bis_skin_checked="1"  style="width: 60%; margin: 50px auto;">
  <div class="card-body" bis_skin_checked="1">
    <h6 class="card-subtitle mb-2 text-muted" id="commentWriter" th:text="${nickname}"></h6>
    <div bis_skin_checked="1">
                <textarea type="text" class="form-control" placeholder="내용" id="commentContent"
                          style="margin-top: 10px; margin-bottom: 10px;" rows="3"></textarea>
    </div>
    <button type="button" class="btn btn-success" style="float: right;" onclick="commentWrite()">댓글작성</button>
  </div>
</div>


<div id="comment-list">
  <div class="card" bis_skin_checked="1" th:each="comment: ${commentList}" style="width: 60%; margin: 15px auto;">
    <div class="card-body" bis_skin_checked="1">
      <h6 class="card-subtitle mb-2 text-muted" th:text="${comment.commentWriter}"></h6>
      <p class="card-text" th:text="${comment.commentContents}"></p>
      <div style="text-align: right">
        <p th:text="*{#temporals.format(comment.commentCreatedTime, 'yyyy-MM-dd HH:mm:ss')}"></p>
        <a href="#" class="card-link"
           th:data-comment-id="${comment.id}" th:data-comment-writer="${comment.commentWriter}" th:data-comment-contents="${comment.commentContents}"
           onclick="showEditCommentForm(this)">수정</a>
        <a th:href="@{|/comment/delete/${comment.id}|}" class="card-link" onclick="confirmDelete()">삭제</a>
      </div>
    </div>
  </div>
</div>

<div class="card" bis_skin_checked="1" style="width: 60%; margin: 50px auto; display: none;" id="editCommentCard">
  <div class="card-body" bis_skin_checked="1">
    <h6 class="card-subtitle mb-2 text-muted" id="editCommentWriter"></h6>
    <div bis_skin_checked="1">
      <textarea type="text" class="form-control" placeholder="내용" id="editCommentContent"
                style="margin-top: 10px; margin-bottom: 10px;" rows="3"></textarea>
    </div>
    <button type="button" class="btn btn-success" style="float: right;" onclick="editComment()">댓글수정</button>
  </div>
</div>

</body>
<script th:inline="javascript">
  const commentWrite = () => {

    const writer = [[${nickname}]];
    const contents = document.getElementById("commentContent").value;
    const id = [[${myplace.id}]]; // 게시글 번호

    console.log("작성자: ", writer);
    console.log("내용: ", contents);
    console.log("게시글 번호: ", id);

    $.ajax({
      // 요청 방식: post, 요청 주소: /comment/save, 요청 데이터: 작성자, 작성내용, 게시글 번호
      type: "post",
      url: "/comment/save",
      headers: {
        "X-CSRF-TOKEN": $('[name="_csrf"]').val()
      },
      data: {
        "commentWriter": writer,
        "commentContents": contents,
        "myplaceId": id
      },
      success: function (res) {
        console.log("요청성공", res);
        let output = "";

        for (let i in res) {
          output += '<div class="card mb-3" style="width: 60%; margin: 10px auto;">';
          output += '<div class="card-body">';
          output += '<h6 class="card-subtitle mb-2 text-muted">' + res[i].commentWriter + '</h6>';
          output += '<p class="card-text">' + res[i].commentContents + '</p>';
          output += '<div style="text-align: right">';
          output += '<p>' + res[i].commentCreatedTime + '</p>';
          // output += '<a href="#" class="card-link">수정</a>';
          // output += '<a href="#" class="card-link">삭제</a>';
          output += '<a href="#" class="card-link">수정</a>';
          output += '<a href="#" class="card-link">삭제</a>';
          output += '</div></div></div>';
        }

        document.getElementById('comment-list').innerHTML = output;
        document.getElementById('commentContent').value = ''; // 내용 입력란 초기화
      },
      error: function(err) {
        console.log("요청 실패", err)
      }
    })
  }

  // 이 함수를 추가하여 수정 칸이 나타나도록 합니다.
  function showEditCommentForm(element) {
    var commentId = element.getAttribute('data-comment-id');
    var commentWriter = element.getAttribute('data-comment-writer');
    var commentContents = element.getAttribute('data-comment-contents');
    // 수정 칸이 나타나도록 설정
    document.getElementById('editCommentCard').style.display = 'block';

    // 수정 칸에 기존 내용을 채워넣기
    document.getElementById('editCommentWriter').innerText = commentWriter;
    document.getElementById('editCommentContent').value = commentContents;

    // 수정할 댓글의 ID를 저장해둠
    document.getElementById('editCommentCard').dataset.commentId = commentId;
  }

  // 수정된 댓글을 서버에 전송하는 함수
  function editComment() {
    const commentId = document.getElementById('editCommentCard').dataset.commentId;
    const contents = document.getElementById('editCommentContent').value;

    $.ajax({
      type: "post",
      url: "/comment/edit/" + commentId,
      headers: {
        "X-CSRF-TOKEN": $('[name="_csrf"]').val()
      },
      data: {
        "commentContents": contents
      },
      success: function (res) {
        console.log("댓글 수정 성공", res);

        // 수정이 성공했을 때, 해당 댓글만 업데이트
        const editedComment = document.querySelector(`[data-comment-id="${commentId}"]`);

        if (editedComment && editedComment.querySelector('.card-text')) {
          editedComment.querySelector('.card-text').innerText = contents;
        }

        const updatedComment = res;
        updateCommentList(updatedComment);

        // 수정 칸을 다시 숨김
        document.getElementById('editCommentCard').style.display = 'none';

      },
      error: function (err) {
        console.log("댓글 수정 실패", err);
      }
    });
  }

  // 수정된 내용을 비동기적으로 갱신하는 함수
  function updateCommentList(updatedComment) {
    // 기존 댓글 목록을 가져와서 배열로 변환
    const commentList = Array.from(document.querySelectorAll('#comment-list .card'));

    // 수정된 댓글과 일치하는 댓글을 찾아서 내용을 갱신
    commentList.forEach(commentCard => {
      const commentId = commentCard.querySelector('.card-link').getAttribute('data-comment-id');
      if (commentId === updatedComment.id.toString()) { // 이 부분 확인
        commentCard.querySelector('.card-subtitle').innerText = updatedComment.commentWriter;
        commentCard.querySelector('.card-text').innerText = updatedComment.commentContents;
      }
    });
  }

  function confirmDelete() {
    var result = confirm("삭제하시겠습니까?");
    if (result) {
      alert("삭제되었습니다.");
    } else {
      event.preventDefault();
    }
  }
</script>
</html>